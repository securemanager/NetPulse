{
  "name": "PRTG Alerts + Visual Daily Report",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "prtg-alert",
        "responseMode": "onReceived"
      },
      "name": "PRTG Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "functionCode": "// Alerts Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ùˆ Ø«Ø¨Øª Downtime\nconst status = $json[\"status\"];\nconst device = $json[\"device\"];\nconst sensor = $json[\"sensor\"];\nconst reason = $json[\"message\"] || 'Ù†Ø§Ù…Ø´Ø®Øµ';\nconst now = new Date();\n\nlet text = '';\nlet emoji = '';\nlet downData = $workflow.getGlobal('prtg_down') || {};\nlet history = $workflow.getGlobal('prtg_down_history') || {};\n\nconst key = device + '|' + sensor;\n\nif(status === 'Down') {\n  downData[key] = { start: now, reason: reason };\n  $workflow.setGlobal('prtg_down', downData);\n  emoji = 'âš ï¸';\n  text = `${emoji} *PRTG Alert*: Sensor DOWN!\\n*Device:* ${device}\\n*Sensor:* ${sensor}\\n*Reason:* ${reason}\\n*Time:* ${now.toLocaleString()}`;\n} else if(status === 'Up') {\n  if(downData[key]) {\n    const start = new Date(downData[key].start);\n    const diffMins = (now - start) / 60000;\n    const downtime = diffMins.toFixed(2);\n    const downReason = downData[key].reason;\n\n    // ØªØ¹ÛŒÛŒÙ† Emoji Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Downtime\n    if(diffMins < 1) emoji = 'âœ…';\n    else if(diffMins < 3) emoji = 'âš ï¸';\n    else if(diffMins >= 5) emoji = 'ğŸ”´';\n    else emoji = 'âš ï¸';\n\n    // Ø«Ø¨Øª Ø¯Ø± history Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡\n    if(!history[key]) history[key] = { device: device, sensor: sensor, totalDowntime: 0, count: 0, visual: '' };\n    history[key].totalDowntime += diffMins;\n    history[key].count += 1;\n    history[key].visual += emoji;\n    $workflow.setGlobal('prtg_down_history', history);\n\n    delete downData[key];\n    $workflow.setGlobal('prtg_down', downData);\n\n    text = `${emoji} *PRTG Notification*: Sensor UP\\n*Device:* ${device}\\n*Sensor:* ${sensor}\\n*Downtime:* ${downtime} Ø¯Ù‚ÛŒÙ‚Ù‡\\n*Reason:* ${downReason}\\n*Time:* ${now.toLocaleString()}`;\n  } else {\n    text = `â„¹ï¸ *PRTG Notification*: Sensor UP but no previous DOWN record.\\n*Device:* ${device}\\n*Sensor:* ${sensor}\\n*Time:* ${now.toLocaleString()}`;\n  }\n}\n$json[\"telegram_text\"] = text;\nreturn $json;"
      },
      "name": "Prepare Alert & Track History",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "<YOUR_TELEGRAM_CHAT_ID>",
        "text": "={{$json[\"telegram_text\"]}}",
        "parseMode": "Markdown"
      },
      "name": "Send Alert Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "triggerTimes": { "item": [] }
      },
      "name": "Daily Cron",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [250, 600]
    },
    {
      "parameters": {
        "functionCode": "// Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨ØµØ±ÛŒ\nconst history = $workflow.getGlobal('prtg_down_history') || {};\nlet reportLines = [];\nfor (const key in history) {\n  const entry = history[key];\n  reportLines.push(`*${entry.device} - ${entry.sensor}*: ${entry.visual}  ${entry.count} Ù‚Ø·Ø¹ÛŒØŒ Ù…Ø¬Ù…ÙˆØ¹ Downtime: ${entry.totalDowntime.toFixed(2)} Ø¯Ù‚ÛŒÙ‚Ù‡`);\n}\nconst reportText = reportLines.length > 0 ? `ğŸ“Š *Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ PRTG*\\n\\n${reportLines.join('\\n')}` : 'ğŸ“Š Ù‡ÛŒÚ† Downtime Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';\n$json[\"telegram_text\"] = reportText;\nreturn $json;"
      },
      "name": "Prepare Visual Daily Report",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 600]
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "<YOUR_TELEGRAM_CHAT_ID>",
        "text": "={{$json[\"telegram_text\"]}}",
        "parseMode": "Markdown"
      },
      "name": "Send Visual Daily Report",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [650, 600]
    }
  ],
  "connections": {
    "PRTG Webhook": {
      "main": [[{"node": "Prepare Alert & Track History","type": "main","index": 0}]]
    },
    "Prepare Alert & Track History": {
      "main": [[{"node": "Send Alert Telegram","type": "main","index": 0}]]
    },
    "Daily Cron": {
      "main": [[{"node": "Prepare Visual Daily Report","type": "main","index": 0}]]
    },
    "Prepare Visual Daily Report": {
      "main": [[{"node": "Send Visual Daily Report","type": "main","index": 0}]]
    }
  }
}
